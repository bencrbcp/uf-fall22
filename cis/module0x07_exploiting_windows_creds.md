# MODULE 0x070 LECTURE 0x180 - UNIX/LINUX INTRO PASSWORD SECURITY

## SMB: Windows Server Message Block service

* It supports file sharing with the Common Internet File System (CIFS), network browsing, printing service, and interprocess communication.
    - Also supports network browsing, printing, etc.
    - If a machine is NOT providing these capabilities for other machines, this service should be OFF.

* Runs on TCP ports 139, 445
    - Also UDP ports 137, 138

* SMB is of utmost importance to pentesters
    - This is a client gets access to SMB by passing authentication tokens (hashed passwords).
    - These may be subject to interception and can be used to impersonate users

### QUIZ ACCESS CODE
Porter Robinson - Unfold


## Microsoft Authentication Protocol History

LM: 14 character password. No salt. Only authenticates client (weakly) to server. DES-based encryption. **EASY TO CRACK.**

NTLM Challenge Response: Allowed use of LM hash or NT hash (MD4)

NTLMv1: Server-generated challenge

NTLMv2: Mutual authentication of server and client. Can no longer just pretend to be a server and nothing else as an attack.

Kerberos (Windows 2000): Requires NT hash for authentication, also public key scheme.


* Useful diagrams from powerpoint:
    - https://www.sans.org/blog/protecting-privileged-domain-accounts-network-authentication-in-depth/


## LMv1/NTLMv1 challenge-response

A rogue server can capture hashed passwords using a static salt (1122334455667788) and use rainbow tables (based on the particular challenge) to get the password.


## LMv2/NTLMv2

The diagram omits the server response to the client challenge.
It's possible to use brute-force or dictionary attack, but not possible to comptue rainbow tables.


## NTLM reflective attack

This uses the client itself as a server, letting it provide server responses.
MS08-068 Patch: SMB refuses to answer a challenge that is has just issued


## NTLM relay attack

Exploited by Zack Attack.
Can be avoided using Extended Protection Authentication (EPA) on a per-service basis


## Kerberos (MIT)

Trusted third-party architecture Ditch NTLM, right?


## NTLM still required

For the following situations:
- Client authenticates to server using IP address
- Client authenticates to server belonging to a different AD forest (more about this later) using legacy NTLM trust instead of transitive inter-forest trust.
- Client authenticates to server not in the domain
- Firewall restricts Kerberos ports

Sites still use NTLMv1


## Mitigations

* Local security policy in Windows servers can prevent this by denying outgoing NTLM traffic (see lecture vid)

* Blocked events are logged
    - This provides a way to detect exploit attempts to your network.

* You can enforce NTLMv2 in the local security policy


## What if you can't use NTLMv2?

You need to take some extra precautions:

* Use passwords longer than 14 characters
* If password is less than 8 chars, then predictable second half of hash:
    - 0xAAD3B435B51404EE
