# MODULE 0x070 LECTURE 0x1c0 - CAPTURINNG WINDOWS HASHES

## SMB - What is it, really?

The Windows Server Message Block service.

* Supports file sharing with the Common Internet File System (CIFS), network browsing, printing, services, interprocess communication

* TCP ports 137, 139, and 445 as well as UDP ports 137 and 138 are used to support SMB
    - Most common on Windows servers are TCP 139 and 445
    - These ports should not be open if machine is not providing any SMB services to other computers


* SMB is of most importance to penetration testers because a client gets access to SMB by passing authentication tokens (hashed passwords).
    - These may be subject to intersection, and can be used to impersonate users


## Microsoft Authentication Protocol History

* LM
    - 14 character password
    - no salt
    - Only authenticates client (weakly) to server -- server doesn't authenticate itself
    - DES-based encryption
    - Easy to crack

* NTLM Challenge-response
    - Allowed use of LM hash or NT hash (MD4)
    - Improvement on LM authentication, but only the hash portion of it.
    - Still no server authentication

* NTLMv1
    - Server-generated challenge

* NTLMv2 (Windows NT 4.0, late 1996)
    - Mutual authentication of server and client
    - Can't just pretend to be a server without doing anything else

* Kerberos (Windows 2000)
    - Requires NT hash for authentication
    - Requires client and server to have elements of public encryption scheme (so that neither alone can forge info to the other)

### QUIZ ACCESS CODE
Porter Robinson - Unfold


## Where can I find this information?

* Many useful diagrams from:
    - [Protecting Privileged Domain Accounts: Network Authentication In-Depth](https://www.sans.org/blog/protecting-privileged-domain-accounts-network-authentication-in-depth/)


## LMv1/NTLMv1 Challenge-Response

A rogue server can capture hashed passwords using a static salt (1122334455667788) and use rainbow tables (based on the particular challenge) to get the password.

1. Client requests a logon to the server or requests access to some SMB service
2. Issue Server Challenge (Rogue server says, "oh, here's the salt, go ahead and encrypt your password appropriately using DES for LMv1 or RC4 for NTLMv1")
3. Answer to Server Challenge ("Ok, here's my hashed password" -> rogue server goes and looks up the hashed password in the rainbow tables)


## NTLMv2 and LMv2

The diagram (see SANS link) omits the server response to the client challenge.
It's possible to brute-force or dictionary attack, but not possible to compute rainbow tables.

1. Logon Request (client requests to logon to the server)
2. Issue Server Challenge (server says "ok here go ahead and encrypt your password using my 1122334455667788 salt")
3. With LMv2/NTLMv2, the "answer" is based off challenge sent from server + a new challenge for server (to identify itself)
    - This last step keeps us from being able to use rainbow tables


## NTLM Reflective Attack

This uses the client itself as a server, letting it provide server responses.
MS08-068 patch: SMB refuses to answer a challenge it has just issued

1. Client Requests Logon
2. Server requests the same Logon from Client (this assumes client's SMB service is available, if client is not running an SMB service, can't use this attack)
3. Client provides a challenge from the server ("here's my challenge to you")
4. Server redirects the challenge back at the client itself
5. The client answers its own challenge, sends answer to server
6. Server provides the same answer to client (we just got access to the service that the client was requesting from someone else)


## NTLM Relay Attack

Exploited by [Zack Attack](https://www.csoonline.com/article/2222964/owned-in-60-seconds-with-zackattack--from-network-guest-to-windows-domain-admin.html)
Can be avoided using __Extended Protection for Authentication (EPA)__ on a per-service basis

MitM style:

1. Client (victim) requests logon to rogue server
2. Rogue server requests logon to actual server
3. Actual server challenges rogue server
4. Rogue server challenges victim with same challenge
5. Client returns answer to rogue server
6. Rogue server passes that on to actual server


## Kerberos (MIT)

Trusted third-party architecture. Ditch NTLM, right?

1. Client requests TGT from the KDC (Kerberos Domain Controller)
2. Authentication service (KDC) provides encrpyted TGT and session key
3. Client requests server access from TGS (Ticket Granting Server)
4. TGS sends an encrypted session key and a ticket
5. Client sends that service ticket to another server (it doesn't know what to do with it yet)
6. Server sends back encrypted timestamp for client validation (can't do this if it's a rogue server -- needs certain info from KDC to encrypt)


## NTLM is still required

For the following situations:

- Client authenticates to server using just their IP address
- Client authenticates to server belonging to different Active Directory forest (more info about this later) using legacy NTLM trust instead of transitive inter-forest trust
- Client authenticates to server that is not in the domain
- Firewall restricts ports that Kerberos uses

* Do sites still use NTLMv1?
    - A: yes.


## Since Windows 7 and Server 2008 R2

* On these systems, you can provide a policy that allows a server to authenticate with NTLM


## Blocked events are logged

* This provides a way to detect attempts to exploit your network
    - Defualt behavior on Windows
    - e.g. You can look at event 4001 (NTLM event) if you have a group policy to block NTLM traffic


## Recommendations to Secure NTLM

* Enforce NTLMv2 in Local Security Policy if you can
    - This makes it so rainbow tables can't be used to cpature passwords for hashes that are passed
    - e.g. `Network Security: LAN Manager authentication level -- Send NTLMv2 response only. Refuse LM & NTLM`


## What if you can't use NTLMv2?

If your network still needs to use NTLM for some reason, then you need to take extra precautions.

* Use passwords longer than 14 characters!
    - This will prevent storage of a valid LM hash (also, remember that LM hashes are stored into 7-character pieces)

* If a password is less than 8 characters, the second half of the LM hash will be: `0xAAD3B435B51404EE`
    - This is a dead giveaway to hackers worth their salt (pun intended)





# MODULE 0x070 LECTURE 0x1d0 - PASS THE HASH PSExec Relay

## LSASS - LOCAL SECURITY AUTHORITY SUBSYSTEM SERVICE

User mode process -- `%SystemRoot%\System32\lsass.exe`

Responsible for:
- Local System Security Policy
    - Which users can log in
    - Password policies
    - User/group privileges
    - Provides System security auditing settings (tracking events)
- User authentication
- Auditing messages sent to the Event log


## Windows Hashes

Two types:
1. LM (used only for LM authentication)
2. NT (used for NTLM, NTLMv2, and possibly Kerberos authentication)

LSASS caches hashes in memory when a user logs in
    - So it can have quick access to them later
    - Not sus at all!

* If a login password is 14 characters or less, it will be stored in the local Security Accounts Manager (SAM) file or in Active Directory with no salt
    - No salt = practically plaintext, because of rainbow tables


## How can hashes be stolen?

* Sniff a hash on the network or use a rogue SMB server to get the hash delivered as discussed previously
* Find a hash stored in the SAM file in `%windir%\system32\config`
    - or Emergency Disk File in `%windir%\repair\RegBack`
    - (Boot from removable media to see the filesystem)
    - If the system is a Domain Controller (DC), this contains __every domain account hash.__
* Dump locally using `pwdump`, `fgdump`, `gsecdump`, or Cain and Abel (`cain`)
* Dump remotely using Cain, Metasploit, Canvas (from Immunity), Core Impact (from Core Security)
* Dump memory then inspect offline using a tool such as `mimikatz`.


## How are hashes passed?

* Use a modified  that will __accept hashes directly__ (instead of only passwords).
    - Normally, a username and password are presented by a user to an SMB client and then hashed and sent to an SMB server
    - `smbclient` on Linux can do this with the `–pw-nt-hash` option
* Use SMBshell (Nessus script plugin)
* Use `hydra`
* Use metasploit's `psexec` exploit
* Use `msvctl` from Truesec
* Use Pass-The-Hash-Toolkit (pshtoolkit) from Hernán Ochoa (Core security)


## Pass-The-Hash Toolkit

Includes a variety of executables:
`genhash.exe`
    - Generates LM and NT hashes from a password (useful for testing correct use of other tools)
`whosthere.exe` and `whosthere-alt.exe`
    - Retrieves user info such as NT hashes from logon sessions still recorded in memory
    - Regular version is _stealthy_ and specialized
    - Alt version is more generic and should work on more systems
    - This is the kind of thing you can also get through mimikatz
`iam.exe` and `iam-alt.exe`
    - Passes hashes.
    - When executed locally, your user identity will be modified based on the provided hash.
    - Regular version reads info from memory, so is more stearlthy
    - Alt version more generic, works on more systems

* For extremely diffuclt cases to capture hash from memory:
    - Hernan describes a way to use the IDA disassembler to extract addresses needed to guide the hash collection process


## Which systems are vulnerable?

Any system that uses LM or NTLMv2 is potentially vulnerable, _even though Microsoft has issued patches to address this problem._

If Kerberos is employed, and one can downgrade authentication to NTLM, then Kerberos is at risk as well.


## Has this really been fixed?

* It has been widely reported that Windows 8.1 and higher are not susceptible to pass-the-hash.
    - [Example](https://www.csoonline.com/article/2612325/windows-8-1-stops-pass-the-hash-attacks.html)

* But... as reported by Sam Browne (among others), by adding a registry entry:
    - `\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy` with DWORD value 1 and disabling Windows Defender, pass-the-hash is __still possible__.

* Why would anyone think of setting this registry key in such a way?
    - Will Schroeder (harmj0y) has a [blog post](https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167) on the subject that references Microsoft documents that suggest stituations in which one might apply this modification.
    - Admins searching for a solution to a problem will jump at recommendations of this sort


## More modern relay attacks

Yaron Zinar and Marina Simakov (security researchers @Preempt) DEFCON 27 talk: Relaying credentials has never been easier
    - [Defcon vod](https://www.youtube.com/watch?v=vIISsfLh4iM)

* They report they haven't seen a single environment that disables NTLM completely

* Zinar and Simakov bypassed two critical protections:
    - Extended Protection for Authentication (EPA) -- this is the thing that renders the Zack Attack impossible
    - LDAPS Channel Binding

* Session signing is a good mitigation for NTLM relay, but is not usually employed
    - This works by signing the session with the password hash of the user (only known to domain controller and client, not to the server)
    - Once again, not many installations implement this.

### Enhanced Protection for Authentication
ITF RFC 5056

* Binds NTLM authentication to a secure channel

* Adds a channel binding field (whose value is based on a hash of the server's certificate) to the last authenticate message
    - Can't be relayed by a machine that doesn't have the server's certificate

### CVE 2015-005
After authentication, attacker can spoof NETLOGON message and receive the session key.

* Microsoft "fix":
    - require NETLOGON to match the NetBIOS computer name of the requester to the NetBIOS computer computer name of the original request

* Bypass method (Simakov and Zinar):
    - use a __blank__ NetBIOS computer name in the authenticate request and NETLOGON request the DC to get session key.
    - Then, send the correct authenticate request with the correct Message Integrity Code (MIC) to the server who will get the session key from the DC
    - If you can relay a session of a privileged user to a DC, you can execute code remotely or dump any credentials.

* Fixed in June 2019
    - Blank names in NETLOGON requests are refused at the server, but attack will ALWAYS work in NTLMv1.
    - Patch is __applied to servers,__ not to DC

### Drop the MIC
Message Integrity Code (MIC) verifies messages between client and server

* Remove Version flag, MIC, and modify Negotiate flag in NTLM Authenticate message when relaying to server
    - Authentication still occurs if bit says that "MIC is present" is set...
    - ...(it doesn't check if MIC is actually there, only if the bit is set)

* Fix:
    - Require the MIC if the bit is set (actually check that it's a nonempty field)

* Some clients (Firefox on Linux/Mac) do not set the MIC.
    - They are vulnerable

### EPA Bypass
EPA adds Channel Binding Field to last NTLM auth message, signed by user's password hash

* Compute a valid channel bindings field and send message to another Channel Bindings field with 0 values

* Fix:
    - Deny requests with multiple channel bindings

* Clients not supporting EPA are still vulnerable





# MODULE 0x070 LECTURE 0x1e0 - KERBEROS GOLDEN AND SILVER TICKETS

## Kerberos

The Sad Fact:

"One time I had to explain Kerberos to someone.
Then we both didn't understand it."


* Where can I find more about this?
    - [Kerberos in the Crosshairs article](https://www.sans.org/blog/kerberos-in-the-crosshairs-golden-tickets-silver-tickets-mitm-and-more/) by Mike Pilkington


## Kerberos Concept

The Key Distribution Center (KDC) is a trusted third party (a _Domain Controller_ in the Microsoft implementation)

* To use a service, a user requests a **service ticket** from the KDC.
    - This is unique to the user and describes the service.
    - Contained in a _Privileged Attribute Certificate (PAC)_

* [ADsecurity.org](https://adsecurity.org/?page_id=183) has a comprehensive list of services employed by AD
    - Exmaples include IPP (printing), MongoDB, IMAP, SMTP, CIFS, RDP, RPC...
    - Q: To be clear, when you request a service ticket, you're requesting a service on another host in the Active Directory domain, NOT a host on the domain controller itself?

* The ticket and the set of temporary encryption keys are given to the user __and__ the service.
    - This allows the client to verify the server and the server to verify the client.
    - Client and server use keys to authenticate and to encrypt communications.


## Using Kerberos

1. Authentication service request
    - User contacts KDC's authentication service to ask for a special Ticket-Granting-Ticket (TGT)
    - This is done by encrypting current timestamp with a client __long-term key.__
    - The TGT allows you to _get a ticket,_ confirms who you really are (authentication)

* To exploit this, attacker uses the simplest encryption scheme (RC4)...
    - ...in which case, the user's password hash is employed as the long-term key.
    - All other encryption keys must be removed from memory to ensure this will work (there are processes for doing this).
    - In other words, if you have the user's RC4 password hash, then you can pretend to be the user.
    - Benjamin Delpy (mimikatz creator) calls this overpass-the-hash because the TGT can provide access to __all Kerberos services.__

2. Authentication Service Response
    - If the timestamp requirement is met, the KDC returns a TGT encrypted using the service's long term key
    - This ticket has a validity time limit (default = 10 hours) but __there is no state information verifying that the ticket was granted by the KDC.__
    - e.g. if someone can forge a ticket, there is no way that anyone will know that the ticket was forged.
    - KDC will re-verify account information when a ticket more than 20 mins old is used (so if you use a ticket quickly, you avoid re-verification)

3. Ticket Granting Service Request
    - The client checks the TGT to see if it isn't expired and sends it to the ticket granting service on the KDC.
    - If it's properly encrypted with the krbtgt account's long-term key and less than 20 mins old, we continue to step 4 to create a service ticket.

* Golden Ticket Attack
    - What if an attacker has the long-term key for the krbtgt account?
    - The attacker can __forge a TGT for any user (even ones that don't exist)__ in any domain you choose for any service (that is authorized by the KDC)
    - The password and thus the keys for the krbtgt rarely change!
    - If you do reset the krbtgt account's password, it must be reset __twice__ (old passwords are still honored -- cached)

4. Ticket Granting Service Response
    - After the TGS verifies the TGT, it creates the service ticket.
    - The client identity from the TGT is copied into the new client's PAC
    - The service ticket is given to the client (who will present it to the server)

* Silver Ticket Attack
    - If an attacker has a service's long-term key, it can forge a PAC which will most likely __not be checked__ against the KDC.
    - Performing PAC validation "implies a cost in terms of time and bandwidth usage" -- this is Microsoft's excuse for this.

5. Application Server Request
    - The user provides the ticket to the application server
    - The application server decrypts the ticket with the service account's long-term key
    - Application server checks user info in the ticket and decides whether or not to provide service.
    - The application _can_ validate the PAC with the KDC, but __almost no services actually do this (even when configured to do so)__

6. Verify the service ticket PAC  (optional)
    - It ain't gonna happen even if you set the registry entry ValidateKdcPacSignature to 1

7. Application Server Response
    - In step 5, the user can requesst that the server identify itself.
    - Server does this by encrypting the timestamp with the session key (which only it should be able to determine)

#### Sidenote on Mimikatz
"Mimikatz is both an exploit on Microsoft Windows that extracts passwords stored in memory and software that performs that exploit"

"Mimikatz is an open-source application that allows users to view and save authentication credentials such as Kerberos tickets. The toolset works with the current release of Windows and includes a collection of different network attacks to help assess vulnerabilities.

Attackers commonly use Mimikatz to steal credentials and escalate privileges because in most cases, endpoint protection software and antivirus systems will not detect or delete the attack. Conversely, pen testers use Mimikatz to detect and exploit vulnerabilities in your networks so you can fix them."


## Summary of Exploitation Requirements for Kerberos

* Golden Ticket
    - NT hash of the krbtgt account (gotten by compromising the DC and elevating privileges to full administrator)

* Silver Ticket
    - NT hash of the targeted service account

**For both **: Need the target domain account name, the domain name, domain's SID (Security ID)


## Mitigations

* Golden Ticket
    - If you know your DC was pwned, change the krbtgt account password _twice._
    - Refresh passwords often to avoid use of stolen credentials

* Silver Ticket
    - The MS Managed Service Account feature changes passwords every 30 days (you can do this manually as well)

**For both**: Disable RC4 encryption with a Group Policy Option (GPO) if you have no Windows XP, 2003, or earlier systems (and you shouldn't)


## Useful video on methods for persistance:

* Grant Bugher, defcon23:
    - https://www.youtube.com/watch?v=gajEuuC2-Dk
    - Covers: creating domain admin accounts, installing autorun malware, creating registry backdoors, Skeleton Key Patch, Golden Tickets, SID History tampering, Active Directly DACL tampering
    - Plus detection and remediation methods





# MODULE 0x070 LECTURE 0x1f0 - THE MANY MODULES OF MIMIKATZ

## Mimikatz wiki

* Most of what you need to know is here
    - https://github.com/gentilkiwi/mimikatz


## The joys of debug privilege

In the Microsoft security model, a privilege is a right to perform privileged Operating System operations

* If a process has the __debug__ privilege, it can debug any process or the kernel
    - This lets one inspect the contents of essentially any Windows libraries in memory...
    - ...including the **Local Security Authority Subsystem Service (LSASS)**, which enforces security policies and keeps track of access tokens.
    - SAM database has hashed passwords, SAM may have cached information from a variety of places; since it's responsible of security, it has access to the SAM.

* Although there is no MS user documentation for LSASS internals, the data they store have been reverse engineered
    - [https://undocumented.ntinternals.net](https://undocumented.ntinternals.net)

* Benjamin Delpy's Mimikatz uses the debug privilege to get a wealth of info that can be used for a bunch of purposes


## What kind of functions does Mimikatz support?

- Enable debug privileges
- Dumping hashes that are stored in LSASS memory
- Manipulate processes and services
- Export certificates and private keys
- Impersonating users
- Inserting skeleton keys (extra passwords)
- Reading the location of minesweeper mines from memory (lol).


## Who can get debug privilege?

* Usually administrators
    - At a certain level of development, you need debug privileges
    - In reconaissance, you would be on the lookout for users with this privilege

* Windows maintains a set of privileges that are associated with processes, together with privilege state (enabled or disabled).
    - A process that cannot enjoy a privilege may be denied privilege or it may indeed have that privilege, but it may be disabled


## Enabling debug privilege in Mimikatz

* Mimikatz has a bunch of modules.
    - You can get a list of modules by typing an inexistant module name followed by two colons, `::`

* The debug privilege is set by using the debug function in the privilege module
    - Execute this with `privilege::debug`
    - If the privilege is available to you, it will be enabeled (it's normally disabled)


## Let's go right for the jugular

The LSASS module holds hashes of users and also maintains actual passwords in some cases

* You can dump cached passwords with the logonPasswords function in the sekurlsa module
    - `sekurlsa::logonpasswords` -- dumps logon passwords if any are held by the current LSASS library
    - This shows information cached in the LSASS library.
    - This includes users who have logged on since last boot and what password they used.

* If you are unable to execute `sekurlsa::logonpasswords`:
    - You may be able to elevate privs with `token::elevate` then dump the SAM database with `lsadump::sam`
    - This will provide us with any LM or NTLM hashes in many versions of Windows (on newer versions it may fail)


## What about information for making golden tickets

You need to know the domain security identifier (SID). This can be gotten from:

- `whoami /user`

* The domain SID is the part that starts with S-1 and ends just before the rightmost dash
    - e.g. `S-1-5-21-2023760972-332825889-808861600`
    - Q: so the above example would end at `5889`?


## What else do I need

If you want a golden ticket, you need the krbtgt hash

* Mimikatz providess the module `kerberos` to deal with such things
    - The function `hash` in that module will yield the krbtgt hashes
    - `kerberos::hash`

* You can use the RC4 or AES hash to manufacture a ticket
    - You also need a username (why not Administrator) and the domain
    - Can find this out username from the UID (500 is administrator)

## How do I manufacture the ticket?

* e.g. `kerberos::golden /admin:Administrator /domain:f4rmc0rp.com /sid:S-1-5-21-2023760972-332825889-808861600 /krbtgt:deadbeeffcafefcafe0031132312930 /ticket:Administrator.tkt`
    - A golden ticket for the Administrator account in the domain `f4rmc0rp` will be manufactured and stored in the file `Administrator.tkt`

* You can also specify group accesses the ticket will enable
    - This is done for if the Administrator happens to not belong to some service groups that you want


## How do I use a Golden ticket?

* Execute the pass-the-ticket function in the Kerberos module
    - `kerberos:ptt`
    - Your process will be permitted any services that the ticket (krbtgt) grants

* Defcon talk:
    - https://www.youtube.com/watch?v=lJQn06QLwEw


## Mimikatz Summary

* mimikatz is a great tool.
    - Numerous capabilities, mostly associated with information about passwords, getting you cached infromation that's stored either in LSASS or SAM.





# MODULE 0x070 LECTURE 0x200 - Windows Post-exploitation

## Remote Desktop (RDP)

* Usually on TCP port 3389

* Kali contains an rdesktop executable for using this on Linux
    - Alternative: remmina
    - `rdesktop 172.16.28.138`

* You can also share a directory when you log in, e.g. share mimikatz Win32 directory: `rdesktop -r disk:win32=/usr/share/windows-resources/mimikatz/Win32 [target IP]`
    - To use that directory on the target machine, you must map the drive to a drive letter in Windows.
    - Right-click on "My Computer" or "This PC" in the explorer, selecting Map Network Drive choice in the context menu, then specifying the share name e.g. `Z:`
    - Or just `net use <drive-letter>: share -name`
    - To use the directory in Powershell, you can just reference `\\share-name\`


## What should we do after exploitation?

* Good resource: https://github.com/mubix/post-exploitation-wiki
    - Q: is this still up?
    - Contains post-exploit guides on how to find out about machine configurations, network configurations, users, etc. on a variety of hosts.
    - Also has info about numerous exploits aimed at furthering your control over a network

## Powershell: Microsoft's built-in post exploitation tool

Installed in Windows 7 and above usually

Usually:
* Whitelisted
* Trusted
* Full .NET capabilities
* Can execute code directly without modifying the filesystem
* Many exploitation tools that employ it
* Also a programming language, techincally... not just a shell


## PowerUp

A powershell module that helps you identify Windows host misconfigurations
Linux equivalent -- `enum4linux` ?

One method to run it is to:

1. Either mount the Kali directory that contains PowerUp (`/usr/share/windows-resources/powersploit/Privesc`) remotely on a Windows machine or copy its contents over some other way.
2. Execute the Powershell command. Normall when executed, Powershell will not allow execution of scripts (as a safety factor) -- bypass this with `-exec bypass`.
3. Then execute `Import-Module ...\PowerUp.ps1` to make PowerUp's functions available. You will need to use absolute path to powerup if it is not in the powershell module path.
4. The best function to run is `Invoke-AllChecks` which will look for unquoted service paths, writeable service executables, unattended install files, hijackable .dll locations, as well as various registry and filesystem misconfigurations.

* Avanced PowerUp usage to bypass AV checks:
    - https://rootrecipe.medium.com/advanced-powerup-ps1-usage-ad0f6d713a9f

### CVE 2012-4349: Unquoted Windows Search Path
* Windows lets you use spaces in path names
    - If a service is installed with an unquoted search path, Windows will attempt to make sense of it using combinations of first excluding spaces, then including spaces followed by names as part of the path

* e.g. If a service's path is `C:\Program Files\ABC DEF\ABC DEF.exe`
    - Windows could match on `C:\Program.exe`, or if not then `C:\Program Files\ABC.exe`, or if not then`C:\Program Files\ABC DEF\ABC.exe`

* If any of these directories is writeable by the user, the executable program will be run as a service.


### Checks and helps exploit bad permissions
* Writeable service executables
    - Allows you to replace the service with code that adds a local administrative user, for example.

* Writeable .exe files
    - If privileged services execute the exe file, you can get them to do anything you want at their privilege level

* Finds DLL paths that can be _hijacked_
    - If the system DLL load path includes a writeable directory, you can place a malicious DLL in a path searched earlier than its actual path

* Check AlwaysInstallElevated registry entry
    - If set, any code will be installed as administrator


## DEMO: Windows post-exploitation

* `cp -r /usr/share/windows-resources/mimikatz/Win32/ /tmp/foo` and `cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 /tmp/foo`
    - Making copy of our tools in Kali to avoid getting deleted by victim system when sharing over RDP

* `rdesktop -g95% -r disk:win32=/tmp/foo <windows victim IP>`
    - Not all users shown originally on screen, so g95% is used to adjust display
    - Note that rdesktop doesn't check if the directory you specified actually exists

* `net use`
    - Shows what remote shares are available -- shows the drive we mounted from Kali

* `use z: \\TSClient\win32`
    - `cd Z:\`

* `Powershell -exec bypass`
    - `Import-Module \\TSClient\win32\PowerUp.ps1`
    - `Invoke-AllChecks`

* `Win32\mimikatz.exe`
    - `a::` to get modules help
    - `privilege::debug` -> error b/c Brian is not logged in atm with administrator privileges
    - Solution: start powershell as admin this time
    - `sekurlsa::` for help
    - `sekurlsa::logonPasswords`
    - `token::elevate` elevates us to NT AUTHORITY/SYSTEM
    - (similar to root in linux, except it does not correspond to a user but rather is a securty identifier)
    - `sekurlsa::logonPasswords`
    - `lsadump::`
    - `lsadump::sam`


END MODULE 0x070
