# MODULE 0x0b LECTURE 0x2d0 -- WINDOWS COMMAND LINE ADMIN BASICS

## Why do you need to know this?

* When you exploit Windows hosts over the network, you may or may not be able to have a remote desktop
    - Also, you may not want to use a remote desktop to increase your stealth (someone could be at the desktop and notice the mouse being moved around by you)

* Sometimes, your only option is to use the command-line to achieve your goals
    - "Live off the land"

* Being able to manipulate a system's services, users, group permissions, and firewall settings can be extremely valuable in furthering your pentesting goals.


## Make victims work for you

Once you've compromised a victim, you should make it work for you.

* Good pentesters need to use the same kinds of techniques botnets "providers" use to maintain persistence and control when they take over machines.

* If the machine is easily accessible to you that's good.
    - You may want to create or manipulate users and local groups.

* Well configured victim machines will be running few services. You need to get them to start services up for you to ease your task.


## Users are good. Add them as necessary.

* See what users exist using the net services command, `net`:
    - `net user [username] [password] /add`

* Make an inactive user active:
    - `net user guest /active yes` to activate guest account

* Or, inactivate an active user:
    - `net user Administrator /active no` (a bold move; perhaps to test incident response team?)


## Groups are good. Use them!

* See what groups are available
    - `net localGroup` (if this fails to work, see the next page)

* Service-specific groups also exist, e.g. for RDP, Telnet, etc.
    - The TelnetClients group identifies those users who can connect using telnet.
    - `net localGroup TelnetClients /add`
    - `net localGroup TelnetClients hax0r /add`
    - Usage of telnet is not recommended though b/c primitive and unencrypted

* Other groups identify users that have specific privileges
    - `net localGroup Administrators hax0r /add`


## If net localgroup DOESN'T WORK

Your meterpreter may be running as NT AUTHORITY\SYSTEM
    - Check by executing `getuid`

* If running this executes a 1312 error and you are in a meterpreter context, you may be able to overcome this by issuing this command:
    - `use incognito impersonate_token "NT AUTHORITY\NETWORK SERVICE"` - this gives you the user context that NT AUTHORITY\SYSTEM is otherwise too high for.
    - Then, starting a shell and issuing the command may work for you.


## Some especially useful services

* Telnet
* SSH
* VNC (Virtual Network Connections -- like RDP but on a UNIX machine. Also exists for Windows
* RDP


## Starting and stopping services

`sc.exe` (service control manager) provides comprehensive control over services

Most common sc functions pentesters typically use include:
- Start
- Stop
- Query
- Configure


## How to enable Telnet service

See if it's already running. (sc query shows all services)
    - `sc query tlntsvr`

Configure telnet to start on demand
    - `sc configure tlntsvr start= demand`

Start the service up!
    - `sc start tlntsvr`

Open a firewall connection
    - `netsh firewall add portopening protocol= TCP port= 23 name= telnet mode= enable scope= custom address= [Attacker IP]`


## Other uses of sc

You can view all configured services with:
    - `sc query`

You __stop__ or even __delete__ services such as firewalls, antivirus, etc.
    - Typically, it is better to __stop__ a service rather than to delete it (e.g. antivirus service)
    - You should restart it when you are finished doing whatever the service prevented or made difficult


## When you are finished, clean up!

* Any changes you make to a system break the security model of your client.
    - This may introduce vulnerabilities that can be exploited by other attackers

Before completing your penetration test:

- If you stop any services, restart them
- If you start any services, stop them
- If you open any firewall ports, close them
- If you create any files, remove them
- If you add any groups, delete them


## The cleanup for our example

- `sc tlntsvr stop`
- `netsh firewall delete portopening protocol= TCP port= 23`
- `net localgroup TelnetClients /del`
- `net user hax0r /del`


## WMIC (Windows Management Interface Command-Line)

Relatively old, but works well.

* WMIC lets you consult and configure a huge range of info and settings on local or multiple remote machines

Command structure:
`wmic [global_switches] [/locale:ms_409] <alias> [options|where_clause] [format]`

Typical usage:
`wmic <alias> [where_clause] [verb_clause]`


## WMIC examples

* Sans cheat sheet
    - [Link here](https://www.sans.org/posters/windows-command-line-cheat-sheet/)

- `WMIC SERVICE where state="running" GET caption, name, state > sercies.tsv` tells you what services are running and outputs to file
- `WMIC PROCESS where name='evil.exe' delete` delete any process whose name is 'evil.exe'
- `WMIC /node:remote_computer PROCESS call create "netstat.exe -ano > C:\output.txt` asks the machine named remote computer to create a process runs netstat -ano and outputs it to a file
- `WMIC /node:@workstns.txt /failfast:on PROCESS call create "\\server\share\installer.cmd"` takes a list of workstations and wants to run an installer process on a network share
- `WMIC NTEVENT where "LogFile='system' and Type>'0'"` looks at NT events in system log file that have type greater than zero (shows you what events have occurred)


## Powershell - Learn it, use it!

* Sans cheat sheet
    - [Link here](https://www.sans.org/blog/sans-pen-test-cheat-sheet-powershell/)





# MODULE 0x0b LECTURE 0x2e0 -- MORE WINDOWS EXPLOITS & RESPONDER

## What is LLMNR

Link-Local Multicast Name Resolution

* Multicast and supports IPv6
    - Used when DNS fails to provide a response for a host lookup for bare hostnames on the local subnets, such as printserver or wpad, for example.

* Can be disabled by disabling Network Discovery and disabling Multicast Name Resolution with a group policy in
    - Computer Configuration > Administrative Templates > Network > DNS client
    - It's a good idea to disable LLMNR... it's very often abused by pentesters


## LLMNR failure modes

Mistyped names will be answered by an LLMNR host

* If a request is made to a service at a mistyped hostname, e.g. `\\prntserver` versus `\\printserver`, then the IP address can be provided by a malicious host
    - Malicious host can then act as a MitM and capture credentials intended to be sent to the actual host

[Responder](https://github.com/SpiderLabs/Responder) automates this attack


## What are WPAD and PAC?

WPAD: Web Proxy Auto Discovery Protocol
    - This protocol lets large installations propagate proxy information to their browsers from a centralized file.

Proxy Auto-Config file
    - This is the file used by WPAD to configure a browser's proxy
    - What could possibly go wrong? [MS12-074](https://learn.microsoft.com/en-us/security-updates/securitybulletins/2012/ms12-074)

* If WPAD requests are answered by a malicious host, then a malicious proxy can be provided for each requesting browser
    - i.e. the proxy might not be an official proxy but an evil one


## Browser setup error

If the "Automatically Detect Settings" box is checked in Internet Explorer's Internet Options > LAN settings...
    - ...IE will use to WPAD find the PAC file whenever default proxy lookup is requested by a .NET application


### QUIZ ACCESS CODE
Return to Forever - Space Circus


## How does Responder automate this?

1. Responder responds to the LLMNR request for the WPAD host address
    - __Avoid this by providing a WPAD host entry in DNS!__
2. It delivers a PAC file that configures the browser to use a web proxy that responder provides
3. Responder identifies all URLs and captures all cookies that pass through the proxy
4. Responder can force NTLM authentication when the PAC file is loaded and reports the browser's user hashes
5. Responder can inject code into requested webpages (html,javascript,etc.)


## SMBRelay attacks with Responder

Responder will MitM SMB connections, providing a failure response to the client, but keeping a connection open to the server.

Many corporate systems are set up to automatically use SMB to attempt to get administrative access to hosts that come up unexpectedly on the network
    - This is done with the assumption that as soon as a machine is added, the corporation will want administrative access to it ASAP

The SMB authentication exchange provides usable hashes that Responder captures and stores


## Inveigh - A PowerShell alternative to Responder

If you have control of a Windows box within a network, you might want to use an LLMNR/mDNS/NBNS spoofer/MitM tool like Responder (which is only for Linux)

* [Inveigh](https://github.com/Kevin-Robertson/Inveigh) is a project that implements this capability in PowerShell





# MODULE 0x0b LECTURE 0x2d0 -- WINDOWS COMMAND LINE ADMIN BASICS

## Why did the NSA come about?

* During WWII, Army Signals Agency mostly gathered and decrypted military communications to provide strategic advantages.
    - As the war came to a close, it became clear that diplomatic communications intelligence (COMINT) would be more important in the coming peace time.

* For years, there was a program known as Venona
    - Almost all Soviet codes were broken

* Following an event known as Black Friday (Oct. 29 1948) in which all compromised Soviet codes were replaced by much stronger cryptography...
    - ...the Armed Forces Security Agency (AFSA) was taksed with directing all COMINT activities except tactical cryptography which remained under independent control of the Army, Navy, and Air Force agencies

* On October 24, 1952, Harry Truman, after receiving the Brownell report on the state of the US military's poorly coordinated intelligence issued a directive to create the NSA to direct all SIGNIT activities, independent of the CIA


## What is TAO? (Tailored Access Operations)


## Shadow brokers

* Auctioned off exploit tools developed by the _Equation Group_ (presumably an NSA team)
    - Leak included the Extrabacon exploit (Cisco authentication 0-day for router SNMP)

* TSB released 5 groups of exploits altogether
    - Their final leak (most damaging) included Fuzzbunch exploitation framework and EternalBlue


## EternalBlue patch timing


## Patching fails

* WannaCry used EternalBlue exploit in conjunction with DoublePulsar downloader to achieve its goal


## How does EternalBlue work?

It exploits a buffer overflow opportunity in large non-paged kernel pool memory

Execution chain of events:
1. `srv!SrvOS2FeaListSizeToNt` (OS/2 FEA to NT Full Extended Attribute (FEA) size conversion) is called, resulting in an overflow of Groom Packet's internal metadata.
2. The Memory Descriptor List (MDL) of the overwritten Groom Packet's `SRVNET_BUFFER_HDR` struct results in an arbitrary write-what-where primitive on the next data transmitted
3. MDL is used to disable Data Execution Prevention (DEP) on a fixed static region of the HAL Heap, whose Page Table Entry (PTE) is also fixed.
4. A second malicious OS/2 to NT FEA conversion is used to overwrite the `SRVNET_BUFFER_HDR` again, to change the MDL write target.
5. MDL is used to place shellcode in a newly executable region, prepended with a fake `SRVNET_RECV` struct
6. The address for this `SRVNET_RECV` struct is in the overwritten `SRVNET_BUFFER_HDR`, and contains the "handler" pointer which is the address of the shellcode.
7. The corrupted Groom connection is closed, and the "handler" function filled with shellcode is eventually called in Srvnet.sys


END MODULE 0x0b
